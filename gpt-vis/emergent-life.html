<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emergent Life Visualization</title>
    <style>
        body {
            margin:0;
            overflow:hidden;
            background:#000;
        }
        #canvas {
            display:block;
        }
        .info {
            position:fixed;
            top:10px;
            left:10px;
            color:#0ff;
            font-family:'Courier New', monospace;
            background:rgba(0,0,0,0.5);
            padding:5px 10px;
            border-radius:5px;
            font-size:14px;
        }
    </style>
</head>
<body>
    <div class="info">Emergent Life &mdash; press ESC to close</div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        const gridSize = 120;
        let cellSize = Math.floor(Math.min(width, height) / gridSize);
        if (cellSize < 2) cellSize = 2;
        canvas.width = cellSize * gridSize;
        canvas.height = cellSize * gridSize;

        let grid = new Float32Array(gridSize * gridSize).map(() => Math.random());

        function idx(x, y) {
            return ((y + gridSize) % gridSize) * gridSize + ((x + gridSize) % gridSize);
        }

        function step() {
            const next = new Float32Array(gridSize * gridSize);
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    let sum = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            sum += grid[idx(x + dx, y + dy)];
                        }
                    }
                    const avg = sum / 8;
                    const self = grid[idx(x, y)];
                    // Continuous update using sine-based growth
                    const growth = Math.sin(Math.PI * (avg - 0.35));
                    let val = self + 0.25 * growth - 0.05 * (self - 0.5);
                    if (val < 0) val = 0;
                    if (val > 1) val = 1;
                    next[idx(x, y)] = val;
                }
            }
            grid = next;
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const val = grid[idx(x, y)];
                    const color = Math.floor(val * 255);
                    ctx.fillStyle = `rgb(${color}, ${Math.floor(color * 0.7)}, ${255 - color})`;
                    ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                }
            }
        }

        function loop() {
            step();
            render();
            requestAnimationFrame(loop);
        }
        loop();

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                window.parent.postMessage('close', '*');
            }
        });
    </script>
</body>
</html>
